( function ( wp ) {
    var el = wp.element.createElement;
    var SelectControl = wp.components.SelectControl;
    var useSelect = wp.data.useSelect;
    var useDispatch = wp.data.useDispatch;

    function ProductSelector({ fieldName, label }) {
        var metaFieldName = 'jkm_' + fieldName;
        
        var meta = useSelect(function(select) {
            return select('core/editor').getEditedPostAttribute('meta') || {};
        }, []);

        var { editPost } = useDispatch('core/editor');

        var products = useSelect(function(select) {
            return select('core').getEntityRecords('postType', 'product', { per_page: -1 }) || [];
        }, []);

        var options = products.map(function(product) {
            return { value: product.id.toString(), label: product.name || `Product ${product.id}` };
        });

        function onMetaFieldChange(value) {
            var metaValue = value ? value : [];
            editPost({ meta: { [metaFieldName]: metaValue } });
        }

        return el(SelectControl, {
            multiple: true,
            label: label,
            value: meta[metaFieldName] || [],
            options: options,
            onChange: onMetaFieldChange
        });
    }

    wp.blocks.registerBlockType( 'jkmfs/optional-add-ons-field', {
        title: 'Optional Add-ons',
        icon: 'cart',
        category: 'woocommerce',
        attributes: {
            ids: {
                type: 'array',
                default: [],
            },
        },
        edit: function () {
            return el(ProductSelector, { 
                fieldName: 'force_sell_ids', 
                label: 'Optional Add-ons' 
            });
        },
        save: function () {
            return null; // Content is saved in post meta
        },
    } );

    wp.blocks.registerBlockType( 'jkmfs/mandatory-add-ons-field', {
        title: 'Mandatory Add-ons',
        icon: 'cart',
        category: 'woocommerce',
        attributes: {
            ids: {
                type: 'array',
                default: [],
            },
        },
        edit: function () {
            return el(ProductSelector, { 
                fieldName: 'force_sell_synced_ids', 
                label: 'Mandatory Add-ons' 
            });
        },
        save: function () {
            return null; // Content is saved in post meta
        },
    } );
} )( window.wp );